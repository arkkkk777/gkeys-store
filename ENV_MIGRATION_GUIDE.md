# Руководство по миграции Environment Variables

Это руководство поможет вам обновить переменные окружения в Vercel для соответствия текущей реализации кода.

## Обзор изменений

В текущей реализации кода обнаружены несоответствия между именами переменных в Vercel и ожидаемыми именами в коде. Это руководство описывает необходимые изменения.

## Переменные, требующие переименования

### 1. G2A_API_SECRET → G2A_API_HASH

**Текущая ситуация**: 
- В Vercel используется: `G2A_API_SECRET`
- Код ожидает: `G2A_API_HASH`
- **Статус**: Код поддерживает оба имени для обратной совместимости, но `G2A_API_HASH` предпочтительнее

**Действие**: 
- ✅ **Рекомендуется**: Переименовать `G2A_API_SECRET` в `G2A_API_HASH` в Vercel
- ⚠️ **Альтернатива**: Оставить `G2A_API_SECRET` - код будет работать, но выведет предупреждение в консоль

**Инструкция по переименованию**:
1. Откройте Vercel Dashboard → Ваш проект → Settings → Environment Variables
2. Найдите переменную `G2A_API_SECRET`
3. Скопируйте её значение
4. Создайте новую переменную `G2A_API_HASH` с тем же значением
5. Убедитесь, что переменная установлена для нужных окружений (Production/Preview/Development)
6. Сохраните изменения
7. Удалите старую переменную `G2A_API_SECRET` (после проверки работы)
8. Передеплойте проект

### 2. JWT_EXPIRY → JWT_EXPIRES_IN

**Текущая ситуация**: 
- В Vercel используется: `JWT_EXPIRY=24h`
- Код ожидает: `JWT_EXPIRES_IN`
- **Статус**: Код не использует `JWT_EXPIRY`, используется значение по умолчанию `7d`

**Действие**: 
- ✅ **Обязательно**: Переименовать `JWT_EXPIRY` в `JWT_EXPIRES_IN` в Vercel

**Инструкция по переименованию**:
1. Откройте Vercel Dashboard → Ваш проект → Settings → Environment Variables
2. Найдите переменную `JWT_EXPIRY`
3. Скопируйте её значение (например, `24h`)
4. Создайте новую переменную `JWT_EXPIRES_IN` с тем же значением
5. Убедитесь, что переменная установлена для нужных окружений
6. Сохраните изменения
7. Удалите старую переменную `JWT_EXPIRY`
8. Передеплойте проект

## Переменные, которые можно удалить (не используются)

### 3. POSTGRES_URL

**Текущая ситуация**: 
- В Vercel присутствует: `POSTGRES_URL`
- Код использует: `DATABASE_URL` и `DIRECT_URL`
- **Статус**: Не используется в коде

**Действие**: 
- ⚠️ **Опционально**: Можно удалить, если не используется другими инструментами
- Если вы используете другие инструменты, которые требуют `POSTGRES_URL`, оставьте её

**Проверка перед удалением**:
- Убедитесь, что никакие другие инструменты (мониторинг, бэкапы, и т.д.) не используют эту переменную
- Если не уверены, лучше оставить переменную

### 4. PRISMA_DATABASE_URL

**Текущая ситуация**: 
- В Vercel присутствует: `PRISMA_DATABASE_URL`
- Код использует: `DATABASE_URL` и `DIRECT_URL` (Prisma читает их напрямую)
- **Статус**: Не используется в коде

**Действие**: 
- ⚠️ **Опционально**: Можно удалить, если не используется другими инструментами

**Проверка перед удалением**: Аналогично `POSTGRES_URL`

### 5. CLIENT_ID и CLIENT_SECRET

**Текущая ситуация**: 
- В Vercel присутствуют: `CLIENT_ID` и `CLIENT_SECRET`
- Код использует: `PAYPAL_CLIENT_ID` и `PAYPAL_CLIENT_SECRET` для PayPal
- **Статус**: Не используются для G2A интеграции

**Действие**: 
- ⚠️ **Опционально**: Можно удалить, если не используются
- Если эти переменные используются для других сервисов (не PayPal и не G2A), оставьте их

**Проверка**: Убедитесь, что эти переменные не используются другими интеграциями

## Пошаговая инструкция по миграции

### Шаг 1: Подготовка

1. Откройте Vercel Dashboard → Ваш проект → Settings → Environment Variables
2. Сделайте скриншот текущих переменных (для резервной копии)
3. Убедитесь, что у вас есть доступ к значениям всех переменных

### Шаг 2: Переименование критичных переменных

#### 2.1. G2A_API_SECRET → G2A_API_HASH

1. Найдите `G2A_API_SECRET`
2. Скопируйте значение
3. Добавьте новую переменную:
   - **Key**: `G2A_API_HASH`
   - **Value**: (вставьте скопированное значение)
   - **Environment**: Выберите те же окружения, что и у `G2A_API_SECRET`
4. Сохраните
5. **НЕ удаляйте** `G2A_API_SECRET` пока не проверите работу

#### 2.2. JWT_EXPIRY → JWT_EXPIRES_IN

1. Найдите `JWT_EXPIRY`
2. Скопируйте значение (например, `24h`)
3. Добавьте новую переменную:
   - **Key**: `JWT_EXPIRES_IN`
   - **Value**: (вставьте скопированное значение)
   - **Environment**: Выберите те же окружения, что и у `JWT_EXPIRY`
4. Сохраните
5. **НЕ удаляйте** `JWT_EXPIRY` пока не проверите работу

### Шаг 3: Передеплой и проверка

1. Передеплойте проект в Vercel (или дождитесь автоматического деплоя)
2. Проверьте логи приложения:
   - Убедитесь, что нет ошибок аутентификации G2A
   - Проверьте, что JWT токены генерируются с правильным временем жизни
3. Протестируйте функциональность:
   - Вход в систему (проверка JWT)
   - G2A интеграция (если используется)

### Шаг 4: Удаление старых переменных

**⚠️ ВНИМАНИЕ**: Удаляйте старые переменные только после успешной проверки!

1. После успешной проверки работы приложения:
   - Удалите `G2A_API_SECRET` (если переименовали в `G2A_API_HASH`)
   - Удалите `JWT_EXPIRY` (если переименовали в `JWT_EXPIRES_IN`)
2. Передеплойте проект
3. Проверьте работу еще раз

### Шаг 5: Очистка неиспользуемых переменных (опционально)

Если вы уверены, что переменные не используются:

1. Проверьте использование `POSTGRES_URL`, `PRISMA_DATABASE_URL`, `CLIENT_ID`, `CLIENT_SECRET`
2. Если они не используются, удалите их
3. Передеплойте и проверьте работу

## Чеклист проверки после миграции

После выполнения миграции проверьте следующее:

### Критичные проверки

- [ ] Приложение успешно деплоится без ошибок
- [ ] Нет ошибок в логах Vercel о missing environment variables
- [ ] G2A интеграция работает (если используется):
  - [ ] Нет ошибок аутентификации G2A API
  - [ ] Продукты синхронизируются корректно
- [ ] JWT аутентификация работает:
  - [ ] Можно войти в систему
  - [ ] Токены генерируются с правильным временем жизни
  - [ ] Refresh токены работают корректно

### Дополнительные проверки

- [ ] Нет предупреждений в консоли о deprecated переменных
- [ ] Все API endpoints работают корректно
- [ ] Админ панель доступна и работает

## Откат изменений

Если после миграции возникли проблемы:

### Быстрый откат

1. Восстановите старые переменные в Vercel:
   - Восстановите `G2A_API_SECRET` (если удалили)
   - Восстановите `JWT_EXPIRY` (если удалили)
2. Удалите новые переменные (`G2A_API_HASH`, `JWT_EXPIRES_IN`)
3. Передеплойте проект

### Полный откат

Если быстрый откат не помог:

1. Используйте скриншот переменных из Шага 1
2. Восстановите все переменные в исходное состояние
3. Передеплойте проект
4. Проверьте работу

## Часто задаваемые вопросы

### Q: Можно ли оставить оба имени переменных (старое и новое)?

**A**: Да, но не рекомендуется:
- Для `G2A_API_SECRET` и `G2A_API_HASH`: Код поддерживает оба, но будет предупреждение. Лучше использовать только `G2A_API_HASH`.
- Для `JWT_EXPIRY` и `JWT_EXPIRES_IN`: Код использует только `JWT_EXPIRES_IN`, поэтому `JWT_EXPIRY` можно удалить.

### Q: Что делать, если я не уверен, используется ли переменная?

**A**: Оставьте переменную. Лучше иметь лишнюю переменную, чем удалить нужную и сломать приложение.

### Q: Нужно ли передеплоить после каждого изменения переменной?

**A**: Да, Vercel применяет изменения переменных окружения только после передеплоя. Вы можете:
- Дождаться автоматического деплоя (если включен)
- Или запустить ручной деплой

### Q: Влияет ли миграция на работу приложения?

**A**: 
- Для `G2A_API_SECRET` → `G2A_API_HASH`: Нет влияния, код поддерживает оба имени
- Для `JWT_EXPIRY` → `JWT_EXPIRES_IN`: Да, если не переименовать, будет использоваться значение по умолчанию `7d` вместо вашего `24h`

## Дополнительные ресурсы

- [ENVIRONMENT_VARIABLES.md](ENVIRONMENT_VARIABLES.md) - Полный справочник всех переменных
- [ENV_SETUP_QUICKSTART.md](ENV_SETUP_QUICKSTART.md) - Быстрый старт настройки переменных
- [VERCEL_ENV_SETUP.md](VERCEL_ENV_SETUP.md) - Подробная инструкция настройки в Vercel

---

**Последнее обновление**: 2024-12-23

